<!DOCTYPE html>
<html lang=cn>
<head>
    
        <title>
    珍爱数据，远离 Oracle Cloud -
    Lin Yinfeng
</title>
        
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel=stylesheet type="text/css" href=https://blog.linyinfeng.com/normalize.css>
        <link rel=stylesheet type="text/css" href=https://blog.linyinfeng.com/style.css>
        <script defer src=https://blog.linyinfeng.com/layout-helper.js></script>
        
            
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K74P2G7');</script>
    <!-- End Google Tag Manager -->

        
        
            
                
    <link rel="stylesheet" href="https://blog.linyinfeng.com/katex/katex.min.css">
    <script defer src="https://blog.linyinfeng.com/katex/katex.min.js"></script>
    <script defer src="https://blog.linyinfeng.com/katex/contrib/mathtex-script-type.min.js"></script>
    <script defer src="https://blog.linyinfeng.com/katex/contrib/copy-tex.min.js"></script>
    <script defer src="https://blog.linyinfeng.com/katex/contrib/auto-render.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
    macros: {
        "\\set": "\\left\\{ #1 \\right\\}"
    },
    delimiters: [
        {left: "$$",  right: "$$",  display: true },
        {left: "$",   right: "$",   display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true }
    ]
}
 );
        });
    </script>

            
        
        
            
    <script src="https://giscus.app/client.js"
            data-repo="linyinfeng&#x2F;blog"
            data-repo-id="MDEwOlJlcG9zaXRvcnkxNDMxMjU5NTA="
            data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyOTkyOTcy"
            data-mapping="pathname"
            data-reactions-enabled="1"
            data-theme="light"
            crossorigin="anonymous"
            async>
    </script>

        
        
            <link rel="alternate" type="application/atom+xml" title="Atom" href="https://blog.linyinfeng.com/atom.xml">
        
        
            <link rel="me" href="https:&#x2F;&#x2F;mastodon.li7g.com&#x2F;@yinfeng">
        
    
</head>
<body>
    
        
        <header id="header">
            
            
    <div class="header-container container">
        <h1 id="blog-title" class="title">
            <a href=https:&#x2F;&#x2F;blog.linyinfeng.com>
                <img src="https://blog.linyinfeng.com/favicon.ico" alt="Lin Yinfeng" />
            </a>
        </h1>
        <nav id="global-nav"><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https://blog.linyinfeng.com
                >Home</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https://blog.linyinfeng.com/archive
                >Archive</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https://blog.linyinfeng.com/links
                >Links</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https:&#x2F;&#x2F;github.com&#x2F;linyinfeng&#x2F;blog
                >Source</a></span></nav>
    </div>

            
        </header>
        <div id="main-aside-container">
            
    
        
                <aside id="aside">
                    <div id="aside-container">
                        
    
    <div class="toc-container container">
        <h1 class="title toc-title">Table of Contents</h1>
        
    
        <ul class="toc-parent">
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;posts&#x2F;oracle-fuck-you&#x2F;#shi-yong-qing-kuang>使用情况</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;posts&#x2F;oracle-fuck-you&#x2F;#shi-jian-jing-guo>事件经过</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;posts&#x2F;oracle-fuck-you&#x2F;#fu-wu-zhong-bu-shu>服务重部署</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;posts&#x2F;oracle-fuck-you&#x2F;#hou-xu-ji-hua>后续（计划）</a>
                    
    

                </li>
                
        </ul>
    

    </div>


                    </div>
                </aside>
            
    

            <main id="main">
                <div id="main-container">
                    
    
                    
    
    <article class="article-container container">
        
    <h1 class="title article-title">
        <a class="article-title-link" href="https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;posts&#x2F;oracle-fuck-you&#x2F;">
            
    <span class="draft-indicator">
        
    </span>
    <span>
        珍爱数据，远离 Oracle Cloud
    </span>

        </a>
    </h1>

        
    <div class="dates-container">
        <div class="date-container">
            <time datetime=2023-02-24T10:46:01+08:00>2023-02-24 10:46</time>
 	    
            <span class="date-label">(created)</span>
            
        </div>
        
        <div class="date-container">
	    <time datetime=2023-02-24T10:46:01+08:00>2023-02-24 10:46</time>
            <span class="date-label">(last updated)</span>
        </div>
    </div>
    

        
    <div class="article-taxonomies"><span class="article-taxonomy"><a class="article-taxonomy-name" href="https://blog.linyinfeng.com/tags">
                Tags</a><span class="article-terms"><a class="article-term-name" href="https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;tags&#x2F;oracle&#x2F;">Oracle</a><a class="article-term-name" href="https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;tags&#x2F;oracle-cloud&#x2F;">Oracle Cloud</a><a class="article-term-name" href="https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;tags&#x2F;tu-cao&#x2F;">吐嘈</a></span></span><span class="article-taxonomy"><a class="article-taxonomy-name" href="https://blog.linyinfeng.com/categories">
                Categories</a><span class="article-terms"><a class="article-term-name" href="https:&#x2F;&#x2F;blog.linyinfeng.com&#x2F;categories&#x2F;yun-wei-ri-zhi&#x2F;">运维日志</a></span></span></div>

        
    
        <section class="article-license">
            
                <div class="license-image">
                    <img src="https://blog.linyinfeng.com/license-buttons/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" />
                </div>
            
            <small class="license-text">This work is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a></small>
        </section>
    

        <section class="article-content"><p>我的 Oracle Cloud 免费账户的权限被禁用了，无任何邮件提醒，不提供数据恢复手段。好在我没有部署任何存储有价值数据的服务到 Oracle Cloud 实例上。现已重部署所有服务到其他机器上。提醒大家珍爱数据，远离 Oracle Cloud。</p>
<span id="continue-reading"></span><h2 id="shi-yong-qing-kuang"><a class="zola-anchor" href="#shi-yong-qing-kuang" aria-label="Anchor link for: shi-yong-qing-kuang">
    ⚓
</a>
使用情况</h2>
<ul>
<li>
<p>Tier：Always Free Tier</p>
</li>
<li>
<p>卡：中行跨境通 Visa</p>
</li>
<li>
<p>Region：us-ashburn-1</p>
</li>
<li>
<p>使用时间：2022-09 至 2022-02-23</p>
</li>
<li>
<p>实例：1 台 arm 机器，4C24G，150G 硬盘</p>
<p>日常运行服务：grafana，influxdb，loki，alertmanager，以及作为 nix build server</p>
<p>负载较轻，每日凌晨 hydra build 时负载较重</p>
</li>
</ul>
<h2 id="shi-jian-jing-guo"><a class="zola-anchor" href="#shi-jian-jing-guo" aria-label="Anchor link for: shi-jian-jing-guo">
    ⚓
</a>
事件经过</h2>
<p>2023-02-24 晨发现 github 仓库 <a href="https://github.com/linyinfeng/dotfiles">linyinfeng/dotfiles</a> terraform worflow 报错，查看了 23 日晚 23 点被触发的 workflow 没有报错，因此事件应该发生在 24 日凌晨（东 8 区）。由于帐号在 Oracle 新加坡，不明白为何事件发生在凌晨。</p>
<p>报错内容（<a href="https://github.com/linyinfeng/dotfiles/actions/runs/4258439141/jobs/7409677425">runs/4258439141/jobs7409677425</a>）：</p>
<pre data-lang="txt" style="background-color:#fafafa;color:#383a42;" class="language-txt "><code class="language-txt" data-lang="txt"><span>╷
</span><span>│ Error: 401-NotAuthenticated, The required information to complete authentication was not provided or was incorrect.
</span><span>│ Suggestion: Please retry or contact support for help with service: Identity Compartment
</span><span>│ Documentation: https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/identity_compartment
</span><span>│ API Reference: https://docs.oracle.com/iaas/api/#/en/identity/20160918/Compartment/GetCompartment
</span><span>│ Request Target: GET https://identity.us-ashburn-1.oci.oraclecloud.com/20160918/compartments/ocid1.compartment.oc1..aaaaaaaaikp5stvcw3ynsrbxkermuo4uz7atqo2nmmkn6mh4gnmc3ouokssa
</span><span>│ Provider version: 4.108.1, released on 2023-02-21.
</span><span>│ Service: Identity Compartment
</span><span>│ Operation Name: GetCompartment
</span><span>│ OPC request ID: 1c52a2ed4c66355a2311e9a2c397c49d/D27F3EFEB233947ED8FDBBDB2776B59E/B75CC5B022B3B7A000DEFF6347E1ABC1
</span><span>│
</span><span>│
</span><span>│   with oci_identity_compartment.terraform,
</span><span>│   on oci.tf line 13, in resource &quot;oci_identity_compartment&quot; &quot;terraform&quot;:
</span><span>│   13: resource &quot;oci_identity_compartment&quot; &quot;terraform&quot; {
</span><span>│
</span><span>╵
</span></code></pre>
<p><code>GetCompartment</code> 操作 <code>401</code>，随即尝试打开机器上部署的 grafana 查看，Cloudflare 提示主机无响应。</p>
<p>登录 Oracle Cloud web 页面（它居然还给我登录）查看 instance 状态，结果为：You don’t have permission to view these resources in this compartment. Try another compartment, or contact your administrator for help.</p>
<p><img src="https://blog.linyinfeng.com/posts/oracle-fuck-you/instances-page.png" alt="Instances page says: You don’t have permission to view these resources in this compartment. Try another compartment, or contact your administrator for help." /></p>
<p>看来我的免费实例是彻底挂了。</p>
<h2 id="fu-wu-zhong-bu-shu"><a class="zola-anchor" href="#fu-wu-zhong-bu-shu" aria-label="Anchor link for: fu-wu-zhong-bu-shu">
    ⚓
</a>
服务重部署</h2>
<p>选择重新部署服务到另一台机器上。</p>
<ol>
<li>
<p>清理 terraform 状态。用 <code>state list</code> 获得需要被清理的状态，然后用 <code>state rm</code> 将它们全部从 terraform 状态中删除。</p>
<pre data-lang="txt" style="background-color:#fafafa;color:#383a42;" class="language-txt "><code class="language-txt" data-lang="txt"><span>$ terraform state list | grep oci
</span><span>$ terraform state rm xxxxx.yyy
</span></code></pre>
</li>
<li>
<p>删除 terraform 配置中所有相关的配置。</p>
</li>
<li>
<p>更改 terraform 配置将四个服务的 CNAME 指向新的机器。</p>
</li>
<li>
<p>更改 nixos 配置将四个服务的配置加入新机器的配置，得益于编写模块时特意使模块是机器无关的，只需要复制粘贴并引用模块即可。</p>
</li>
<li>
<p>进行简单的 nixos 配置构建测试。</p>
</li>
<li>
<p>部署 nixos 配置，应用 terraform 配置。</p>
</li>
<li>
<p>测试新部署的服务，成功恢复。</p>
</li>
</ol>
<p>得益于 terraform 和 nixos 本次重部署只花了几十分钟，commit <a href="https://github.com/linyinfeng/dotfiles/commit/153780cbfcac324c87a7fbc2e0eed4559ebc8f4f">Oracle, Fuck You</a> 记录了所有的改动。</p>
<pre data-lang="txt" style="background-color:#fafafa;color:#383a42;" class="language-txt "><code class="language-txt" data-lang="txt"><span>commit 153780cbfcac324c87a7fbc2e0eed4559ebc8f4f
</span><span>Author: Lin Yinfeng &lt;lin.yinfeng@outlook.com&gt;
</span><span>Date:   Fri Feb 24 10:22:01 2023 +0800
</span><span>
</span><span>    Oracle, Fuck You
</span><span>
</span><span>    Oracle Cloud just disabled my free account *without any notice*, and
</span><span>    *does not provide any data recovery method*.
</span><span>
</span><span>    Remove all Oracle OCI state from terraform.  Deploy all services
</span><span>    previously on the Oracle Ampere A1 machine to rica.
</span></code></pre>
<h2 id="hou-xu-ji-hua"><a class="zola-anchor" href="#hou-xu-ji-hua" aria-label="Anchor link for: hou-xu-ji-hua">
    ⚓
</a>
后续（计划）</h2>
<p>计划后续联系一下客服，问问啥情况，不过就算解封了我估计也不会去用了。</p>
</section>
    </article>

    
        
    <div class="giscus" />

    

                </div>
            </main>
        </div>
        <footer id="footer">
            
            
    <div class="footer-container container">
        <div id="copyright-container">
            <small id="copyright">© Lin Yinfeng</small>
        </div>

        
            <div id="powered-by-container">
                <small id="powered-by">Powered by <a href="https://www.getzola.org">Zola</a></small>
            </div>
        
    </div>

            
        </footer>
    
</body>
</html>
